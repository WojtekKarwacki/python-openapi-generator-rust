paths:
  /entity-relations/generations:
    post:
      tags:
        - entity-relation
      operationId: generateEntityRelations
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GenerateEntityRelationsRequest'
        required: true
      responses:
        200:
          description: ok
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GenerateEntityRelationsResponse"
components:
  schemas:
    EntityRelation:
      properties:
        type:
          type: string
      required:
        - type
      oneOf:
        - $ref: '#/components/schemas/EntityRelationExactMatch'
        - $ref: '#/components/schemas/EntityRelationTimeMatch'
        - $ref: '#/components/schemas/EntityRelationTimeRange'
        - $ref: '#/components/schemas/EntityRelationTimeRangeAuto'
      discriminator:
        propertyName: type
        mapping:
          exact-match: '#/components/schemas/EntityRelationExactMatch'
          time-match: '#/components/schemas/EntityRelationTimeMatch'
          time-range: '#/components/schemas/EntityRelationTimeRange'
          time-range-auto: '#/components/schemas/EntityRelationTimeRangeAuto'
    EntityRelationAbstraction:
      type: object
      properties:
        id:
          $ref: '#/components/schemas/EntityRelationId'
        baseAnalyticTableId:
          $ref: 'analytic.yml#/components/schemas/AnalyticTableId'
        relatedAnalyticTableId:
          $ref: 'analytic.yml#/components/schemas/AnalyticTableId'
        columnMapping:
          type: array
          items:
            type: object
            properties:
              baseColumnId:
                $ref: 'table.yml#/components/schemas/ColumnId'
              relatedColumnId:
                $ref: 'table.yml#/components/schemas/ColumnId'
            required:
              - baseColumnId
              - relatedColumnId
      required:
        - id
        - baseAnalyticTableId
        - relatedAnalyticTableId
        - columnMapping
    EntityRelationId:
      $ref: 'api.yml#/components/schemas/Id'
    EntityRelationExactMatch:
      allOf:
        - $ref: '#/components/schemas/EntityRelationAbstraction'
      x-dotdata-discriminator: type
    EntityRelationTimeMatch:
      allOf:
        - $ref: '#/components/schemas/EntityRelationAbstraction'
        - type: object
          properties:
            resolution:
              $ref: '#/components/schemas/TimeResolution'
          required:
            - resolution
      x-dotdata-discriminator: type
    EntityRelationTimeRange:
      allOf:
        - $ref: '#/components/schemas/EntityRelationAbstraction'
        - type: object
          properties:
            from:
              $ref: 'api.yml#/components/schemas/Duration'
            to:
              $ref: 'api.yml#/components/schemas/Duration'
            exploreShorterRanges:
              type: boolean
          required:
            - from
            - exploreShorterRanges
      x-dotdata-discriminator: type
    EntityRelationTimeRangeAuto:
      allOf:
        - $ref: '#/components/schemas/EntityRelationAbstraction'
        - type: object
          properties:
            exploreShorterRanges:
              type: boolean
          required:
            - exploreShorterRanges
      x-dotdata-discriminator: type
    GenerateEntityRelationsRequest:
      oneOf:
        - $ref: '#/components/schemas/GenerateEntityRelationsRequestForTables'
        - $ref: '#/components/schemas/GenerateEntityRelationsRequestForTableSnippets'
      discriminator:
        propertyName: type
        mapping:
          tables: '#/components/schemas/GenerateEntityRelationsRequestForTables'
          table-snippets: '#/components/schemas/GenerateEntityRelationsRequestForTableSnippets'
    GenerateEntityRelationsRequestAbstraction:
      type: object
      properties:
        type:
          type: string
      required:
        - type
    GenerateEntityRelationsRequestForTables:
      allOf:
        - $ref: '#/components/schemas/GenerateEntityRelationsRequestAbstraction'
        - type: object
          properties:
            tables:
              type: array
              items:
                $ref: 'table.yml#/components/schemas/TableId'
          required:
            - tables
    GenerateEntityRelationsRequestForTableSnippets:
      allOf:
        - $ref: '#/components/schemas/GenerateEntityRelationsRequestAbstraction'
        - type: object
          properties:
            tableSnippets:
              type: array
              items:
                $ref: '#/components/schemas/TableSnippet'
          required:
            - tableSnippets
    GenerateEntityRelationsResponse:
      type: object
      properties:
        entityRelations:
          type: array
          items:
            type: object
            properties:
              leftTableColumn:
                $ref: 'table.yml#/components/schemas/TableColumn'
              rightTableColumn:
                $ref: 'table.yml#/components/schemas/TableColumn'
              cardinality:
                type: string
                enum:
                  - one_to_one
                  - one_to_many
                  - many_to_one
                  - many_to_many
            required:
              - leftTableColumn
              - rightTableColumn
              - cardinality
      required:
        - entityRelations
    TableSnippet:
      type: object
      properties:
        tableName:
          type: string
        snippets:
          type: array
          items:
            type: object
            properties:
              column:
                type: string
              vals:
                type: array
                items:
                  type: string
            required:
              - column
              - vals
      required:
        - tableName
        - snippets
    TimeResolution:
      type: string
      enum:
        - millisecond
        - second
        - minute
        - hour
        - day
        - month
        - year
